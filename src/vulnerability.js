const fs = require('fs')
const ROOT = require('app-root-path')
const path = require('path')
const DATA_PATH = `${ROOT}/db/resource`
const $ = require('../db/vulnerability')

async function insert() {
    const dataset = []
    readDirectory(DATA_PATH, dataset)
    const map = {}
    for (const item of dataset) {
        if (map[item.category] !== undefined) map[item.category]++
        else map[item.category] = 0
        await $.insert({ SourceCode: item.content, Vulnerability: item.category })
    }
    console.log(map)
}

// 递归遍历文件夹并读取Solidity文件内容
function readDirectory(directoryPath, dataset) {
    const files = fs.readdirSync(directoryPath)
    const category = path.basename(directoryPath) // 获取文件夹名称

    for (const file of files) {
        const filePath = path.join(directoryPath, file)
        const fileStat = fs.statSync(filePath)

        if (fileStat.isDirectory()) {
            // 如果是文件夹，递归读取其中的文件
            readDirectory(filePath, dataset)
        } else if (file.endsWith('.sol')) {
            // 如果是Solidity文件，读取内容并添加到数据集
            const solidityContent = fs.readFileSync(filePath, 'utf-8')
            dataset.push({ category, content: solidityContent })
        }
    }
}

if (process.argv[1].includes('src/vulnerability')) {
    if (process.argv[2] == 'insert') insert()
}
