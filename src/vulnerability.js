const fs = require('fs')
const ROOT = require('app-root-path')
const path = require('path')
const DATA_PATH = `${ROOT}/db/resource`
const $vul = require('../db/vulnerability')
const $ = require('../src/utils')
const { embedAPI } = require('../tf/utils')

async function insert() {
    const dataset = []
    readDirectory(DATA_PATH, dataset)
    const map = {}
    for (const item of dataset) {
        if (map[item.category] !== undefined) map[item.category]++
        else map[item.category] = 0
        await $vul.insert({ SourceCode: item.content, Vulnerability: item.category })
    }
    console.log(map)
}

// 递归遍历文件夹并读取Solidity文件内容
function readDirectory(directoryPath, dataset) {
    const files = fs.readdirSync(directoryPath)
    const category = path.basename(directoryPath) // 获取文件夹名称

    for (const file of files) {
        const filePath = path.join(directoryPath, file)
        const fileStat = fs.statSync(filePath)

        if (fileStat.isDirectory()) {
            // 如果是文件夹，递归读取其中的文件
            readDirectory(filePath, dataset)
        } else if (file.endsWith('.sol')) {
            // 如果是Solidity文件，读取内容并添加到数据集
            const solidityContent = fs.readFileSync(filePath, 'utf-8')
            dataset.push({ category, content: solidityContent })
        }
    }
}

// embed all: average pool embedding
async function embedAllAvg(start = 1, end) {
    const max = end || (await $vul.maxId())
    for (let i = start; i <= max; i++) {
        const c = await $vul.findOneByPk(i)
        if (!c) continue
        console.log('Embed Avg', i)
        const code = $.getCodeMap($.clearCode(c.SourceCode), 'solidity')
        const json = {}
        for (const i in code) {
            json[i] = {}
            for (const j in code[i]) json[i][j] = await embedAPI(code[i][j])
        }
        const data = {
            Id: i,
            Embedding: JSON.stringify(json)
        }
        console.log(data)
        await $vul.upsert(data)
    }
}

// embed all: max pool embedding
/*
async function embedAllMax(start = 1, end) {
    const max = end || (await $contract.maxId())
    for (let i = start; i <= max; i++) {
        const code = await $contract.getCodeMapById(i)
        if (!code) continue
        console.log('Embed Max', i)
        const json = {}
        for (const i in code) {
            json[i] = {}
            for (const j in code[i]) json[i][j] = await embedAPI(removeBr(code[i][j]), 'embeddingMax')
        }
        console.log(json)
        const data = {
            Id: i,
            EmbeddingMax: JSON.stringify(json)
        }
        await $contract.upsert(data)
    }
}
*/

if (process.argv[1].includes('src/vulnerability')) {
    if (process.argv[2] == 'insert') insert()
    if (process.argv[2] == 'embed') embedAllAvg(process.argv[3], process.argv[4])
}
